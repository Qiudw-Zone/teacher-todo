require(["jquery","highcharts","bootstrap-validator","bootstrap","nicescroll","datetimepicker","ckeditor"],function(t){t(function(){var e=window.location.href,o=decodeURI(e.split("title=").reverse()[0]),a={container:"",status:1,pageSize:6,pages:0},n=t(".index-container"),s={init:function(){this.toogleForm(),this.verifyForm()},toogleForm:function(){n.on("click","#form-nav-text",function(e){e.preventDefault();var o=t(this).data("type");"#reg"===o?(t("#login").addClass("off"),t(this).text("登陆").data("type","#login")):(t("#reg").addClass("off"),t(this).text("注册").data("type","#reg")),t("#submit").data("type",t(this).data("type")),t(o).removeClass("off")})},verifyForm:function(){var e=this,o={login:e.login,reg:e.register};t("#login,#reg").bootstrapValidator({message:"This value is not valid",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{username:{validators:{notEmpty:{message:"用户名不能为空"}}},password:{validators:{notEmpty:{message:"密码不能为空"},stringLength:{min:6,max:9,message:"密码长度为6~9"}}},comfirm_password:{validators:{notEmpty:{message:"密码确认不能为空"},identical:{field:"password",message:"密码不一致"}}}}}).on("success.form.bv",function(e){e.preventDefault();var a=t(this).data("type");o[a]()})},login:function(){t.ajax({url:"/login",type:"POST",data:{name:t("#login-username").val(),password:t("#login-password").val()},success:function(t){console.log(t),1===t.code?window.location.href="/home":alert(t.msg)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})},register:function(){t.ajax({url:"/create-user",type:"POST",data:{name:t("#reg-username").val(),password:t("#reg-password").val()},success:function(t){console.log(t),1===t.code?window.location.href="home":alert(t.msg)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})}},i={dom:t(".home-page"),oldCourseName:"",init:function(){this.initScroll(),this.initUserInfo(),this.initTodos(),this.initPage(),this.initCourse(this.setCourses),this.createCourse(),this.initCourseOperate(),this.initToDoOprate(),this.viewMyTodos(),this.viewTodosInCourse(),this.initPaginate()},initPage:function(){var e=t(".course-wrap");this.dom.on("click",".create-task,#create-course",function(t){t.preventDefault(),e.removeClass("off"),e.fadeIn("600")}),this.dom.on("click",".close-course",function(t){t.preventDefault(),e.fadeOut("600")});var a=t(".table"),n=t(".create-crouse-wrap");this.dom.on("click","#add-course",function(e){e.preventDefault();var o=t(this).data("type");"add"===o?(t(this).text("取消").data("type","cancel"),a.addClass("off"),n.removeClass("off")):(t(this).text("新增").data("type","add"),a.removeClass("off"),n.addClass("off"),t("#btn-course").data("type","add"))}),this.dom.on("click","#nav-course",function(e){e.preventDefault();var o=t(this).data("status");"off"===o?(t(this).data("status","on").addClass("nav-course-open"),t(".courses").slideDown("600")):(t(this).data("status","off").removeClass("nav-course-open"),t(".courses").slideUp("600"))});var s=t(".main-wrap"),i=-1;this.dom.on("click",".list-nav-item",function(e){e.preventDefault();var o=1;o+=t(this).index(),t(".list-nav-item").eq(i).removeClass("list-nav-on"),t(this).addClass("list-nav-on"),i=o-1,s.animate({marginLeft:"-"+100*o+"%"},600)}),this.dom.on("click","#create-todo",function(t){t.preventDefault(),window.location.href="/create?title=Your title"}),this.dom.on("keyup",".add-todo-input",function(e){e.preventDefault(),o=t(this).val(),o&&13===e.keyCode?window.location.href="/create?title="+encodeURI(o):13===e.keyCode&&alert("请先输入TODO标题！")})},initScroll:function(){t(".home-nav,.main").niceScroll({cursorcolor:"#ccc",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"5px",cursorborder:"0",cursorborderradius:"5px",autohidemode:!1})},initUserInfo:function(){var e=t(".user-info-wrap"),o=t(".show-info"),a=t(".edit-info"),n=!0,s=!0;this.dom.on("click",".user",function(o){o.preventDefault(),n&&t.ajax({url:"/get-user",type:"GET",data:{name:username},success:function(e){return console.log(e),1!=e.code?void alert(e.msg):(t("#info-password").text(e.result.password),void(n=!1))}}).done(function(){console.log("success")}).fail(function(){console.log("error")}),s?(e.removeClass("off"),s=!1):(s=!0,e.addClass("off"))}),this.dom.on("click",".info-close",function(t){t.preventDefault(),e.addClass("off")}),this.dom.on("click","#edit-user",function(t){t.preventDefault(),o.addClass("off"),a.removeClass("off")}),this.dom.on("click","#edit-cancle",function(t){t.preventDefault(),a.addClass("off"),o.removeClass("off")}),t("#user-form").bootstrapValidator({message:"This value is not valid",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{username:{validators:{notEmpty:{message:"用户名不能为空"}}},password:{validators:{notEmpty:{message:"密码不能为空"},stringLength:{min:6,max:9,message:"密码长度为6~9"}}}}}).on("success.form.bv",function(e){e.preventDefault();var n=t("#username").val(),s=t("#password").val();t.ajax({url:"/edit-user",type:"post",data:{name:n,password:s},success:function(e){return console.log(e),1!==e.code?void alert(e.msg):(t("#info-name").text(n),t("#info-password").text(s),o.removeClass("off"),void a.addClass("off"))},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},initCourse:function(e){username&&t.ajax({url:"/query-course",type:"get",data:{uname:username},success:function(t){console.log(t);var o=[];1===t.code&&(o=t.result),e(o)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})},initTodos:function(){var e=this;this.dom.on("click",".list-nav-item",function(o){o.preventDefault();var n=t(this).data("type");a.container=t(this).data("id"),a.status=n,t.ajax({url:"/get-todos",type:"get",data:{uname:username,status:n,page:1,size:a.pageSize},success:function(t){console.log(t),e.setTodos(a.container,t)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},initPaginate:function(){var e=this;this.dom.on("click",".page",function(o){o.preventDefault();var n=t(this).data("page");0>=n||n>a.pages||t.ajax({url:"get-todos",type:"get",data:{uname:username,status:a.status,page:n,size:a.pageSize},success:function(t){console.log(t),e.setTodos(a.container,t)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")}).always(function(){console.log("complete")})})},initCourseOperate:function(){var e=this;this.dom.on("click",".remove-course",function(e){e.preventDefault();var o=t(this).data("id"),a=t(this).parents("tr");t.ajax({url:"/del-course",type:"get",data:{id:o},success:function(t){1===t.code&&(alert(t.msg),a.remove())},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})}),this.dom.on("click",".edit-course",function(o){o.preventDefault(),t("#add-course").click(),t("#btn-course").data("type","edit"),e.oldCourseName=t(this).data("name"),t("#coursename").val(e.oldCourseName),t("#courseaddr").val(t(this).data("addr"))})},initToDoOprate:function(){this.dom.on("click",".remove-todo",function(e){e.preventDefault();var o=t(this).data("id"),a=t(this).parents(".todo");t.ajax({url:"/del-todo",type:"get",data:{id:o},success:function(t){1===t.code&&alert(t.msg),a.remove()}}).done(function(){console.log("success")}).fail(function(){console.log("error")})}),this.dom.on("click",".glyphicon-ok",function(e){e.preventDefault();var o=t(this).data("id"),a=-1,n=t(this).parents(".todo");t.ajax({url:"/edit-todo",type:"post",data:{id:o,update:{status:a}},success:function(t){console.log(t),1===t.code&&(alert(t.msg),n.remove())},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},viewMyTodos:function(){var e=this;this.dom.on("click","#my-tasks",function(o){o.preventDefault();var n=0;switch(parseInt(a.status)){case 0:a.container="doing",n=1,t(".list-nav-item").eq(0).addClass("list-nav-on");break;case-1:a.container="finished",n=2,t(".list-nav-item").eq(1).addClass("list-nav-on");break;case 1:a.container="coming",n=3,t(".list-nav-item").eq(2).addClass("list-nav-on")}t(this).data("name");t.ajax({url:"/get-todos",type:"get",data:{uname:username,status:a.status,page:1,size:a.pageSize},success:function(o){console.log(o),e.setTodos(a.container,o),t(".main-wrap").animate({marginLeft:"-"+100*n+"%"},600)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},viewTodosInCourse:function(){var e=this;this.dom.on("click",".course-item",function(o){o.preventDefault();var n=0;switch(parseInt(a.status)){case 0:a.container="doing",n=1,t(".list-nav-item").eq(0).addClass("list-nav-on");break;case-1:a.container="finished",n=2,t(".list-nav-item").eq(1).addClass("list-nav-on");break;case 1:a.container="coming",n=3,t(".list-nav-item").eq(2).addClass("list-nav-on")}var s=t(this).data("name");t.ajax({url:"/get-todos",type:"get",data:{uname:username,status:a.status,cname:s,page:1,size:a.pageSize},success:function(o){console.log(o),e.setTodos(a.container,o),t(".main-wrap").animate({marginLeft:"-"+100*n+"%"},600)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},setCourses:function(e){var o="",a="",n=e.length;if(n>0)for(var s=0;n>s;s++)o+="<tr><td><h4>"+e[s].name+'<small class="ml-15">'+e[s].addr+'</small></h4></td><td><button data-id="'+e[s]._id+'" data-name="'+e[s].name+'" data-addr="'+e[s].addr+'" class="btn btn-primary glyphicon glyphicon-edit edit-course"></button><button data-id="'+e[s]._id+'" class="remove-course ml-10 btn btn-primary glyphicon glyphicon-remove"></button></td></tr>',a+='<li class="course-item" data-id="'+e[s]._id+'" data-name="'+e[s].name+'">'+e[s].name+"</li>";else o='<tr><td class="text-center">还没有课程，赶快添加吧！</td></tr>',a='<li class="course-item">暂未有课程</li>';t("#table-courses").html(o),t(".courses").html(a)},setTodos:function(e,o){var n=o.result,s=n?n.length:0,i="",r="";if(s>0){for(var c=0;s>c;c++)i+='<li class="todo"><p class="todo-info">',n[c].view&&(i+='<i class="todo-new icon-new"></i>'),i+='<a class="todo-name" href="/detail/'+n[c]._id+'">',i+="["+n[c].cname+"]  "+n[c].name+"</a>",i+='<span class="todo-times">'+n[c].btime+" - "+n[c].etime+"</span>",i+='<span class="todo-time">'+n[c].createTime.slice(0,10)+"</span></p>",0===n[c].status?i+='<p class="todo-operate"><button title="标记完成" class="btn btn-success glyphicon glyphicon-ok" data-id="'+n[c]._id+'"></button><button title="删除" class="ml-10 btn btn-warning glyphicon glyphicon-remove remove-todo" data-id="'+n[c]._id+'"></button></p></li>':1===n[c].status&&(i+='<p class="todo-operate"><button title="删除" class="btn btn-warning glyphicon glyphicon-remove remove-todo" data-id="'+n[c]._id+'"></button></p></li>');r='<span data-page="'+(parseInt(o.page)-1)+'" class="prev page">上一页</span>';for(var c=1;c<=o.pageSize;c++)r+=c===parseInt(o.page)?'<span data-page="'+c+'" class="page cur">'+c+"</span>":'<span data-page="'+c+'" class="page">'+c+"</span>";r+='<span data-page="'+(parseInt(o.page)+1)+'" class="next page">下一页</span>'}else i='<li class="todo"><p class="todo-info">暂无数据</p></li>',r='<span class="prev page">上一页</span><span class="next page">下一页</span>';t("#"+e).html(i),t("#page-"+e).html(r),a.pages=o.pageSize},createCourse:function(){var e=this;this.dom.on("click","#btn-course",function(o){o.preventDefault();var a=t("#coursename").val();if(username){if(!a)return void alert("课程名不能爲空！");var n=t("#courseaddr").val();return n?void("edit"===t(this).data("type")?t.ajax({url:"/edit-course",type:"post",data:{name:e.oldCourseName,uname:username,content:{name:a,addr:n}},success:function(t){1===t.code?window.location.href="/home":alert(t.msg)}}).done(function(){console.log("success")}).fail(function(){console.log("error")}):t.ajax({url:"/create-course",type:"POST",data:{name:a,uname:username,addr:n},success:function(e){1===e.code?(t("#table-courses").prepend("<tr><td><h4>"+e.result.name+'<small class="ml-15">'+e.result.addr+'</small></h4></td><td><button data-id="'+e.result._id+'" class="btn btn-primary  glyphicon glyphicon-edit"></button><button data-id="'+e.result._id+'" class="ml-10 btn btn-primary glyphicon glyphicon-remove"></button></td></tr>'),t("#add-course").click()):alert(e.msg)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})):void alert("上课地点不能爲空！")}})}},r={dom:t(".create-container"),action:"add",init:function(){this.initPage(),i.initCourse(this.setCourses),this.createToDo(),this.prevToDo()},initPage:function(){t("#todo-title").val(o),data&&data.name&&(this.action="edit",t("#todo-title").val(data.name),t("#course-name").val(data.cname),t("#btime").val(data.btime),t("#etime").val(data.etime),t(".ckeditor").val(decodeURIComponent(data.content)),t("#create-todo").text("修改")),t(".datetimepicker").datetimepicker(),this.dom.on("click",".course-item",function(e){e.preventDefault();var o=t(this).data("name");return o?void t("#course-name").val(o):void(confirm("暂无课程!是否去创建？")&&(window.location.href="/home"))})},setCourses:function(e){var o="",a=t("#create-courses");if(e.length>0)for(var n=0,s=e.length;s>n;n++)o+='<li class="course-item" data-id="'+e[n]._id+'" data-name="'+e[n].name+'"><a href="javascript:void(0);">'+e[n].name+"</a></li>";else o='<li class="course-item" data-name="null"><a href="javascript:void(0);">暂无课程</a></li>';a.html(o)},getCreateInfo:function(){var e={uname:username,status:1},o=t("#todo-title").val();if(!o)return void alert("ToDo标题不能为空！");e.name=o;var a=t("#course-name").val();if(!a)return void alert("ToDo所属课程不能为空！");e.cname=a;var n=t("#btime").val(),s=t("#etime").val();if(!n||!s)return void alert("相关时间不能为空！");if(n>s)return void alert("结束时间不能小于开始时间！");var i=CKEDITOR.instances.editor.getData();return i?(console.log(i),e.btime=n,e.etime=s,e.content=encodeURIComponent(i),e):void alert("ToDo正文不能为空！")},createToDo:function(){var e=this;this.dom.on("click","#create-todo",function(o){o.preventDefault();var a=e.getCreateInfo();"edit"===e.action?t.ajax({url:"/edit-todo",type:"post",data:{id:data.id,update:a},success:function(t){1===t.code&&(window.location.href="/detail/"+data.id)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")}):t.ajax({url:"/create-todo",type:"post",data:a,success:function(t){console.log(t),1===t.code?window.location.href="/detail/"+t.result._id:alert(t.msg)},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})})},prevToDo:function(){var e=this,o=t(".mask");this.dom.on("click","#prev-todo",function(a){a.preventDefault();var n=e.getCreateInfo(),s=new Date,i=s.getFullYear()+"-"+s.getMonth()+"1-"+s.getDate();t(".prev-title").html(n.name+'<small class="ml-15">'+i+"</small>"),t(".prev-course").text(n.cname),t(".prev-btime").text(n.btime),t(".prev-etime").text(n.etime),t(".prev-text").html(decodeURIComponent(n.content)),o.removeClass("off")}),this.dom.on("click",".prev-close",function(t){t.preventDefault(),o.addClass("off")})}};s.init();var c={dom:t(".main"),init:function(){var e=t("#todo-content-off").html();t("#todo-content").html(decodeURIComponent(e)),this.initPage(),this.initToDoOprate()},initPage:function(){-1===parseInt(todoStatus)?(t(".btn-detail").addClass("disabled"),t(".todo-status").text("已终止")):0===parseInt(todoStatus)?(t("#btn-doit").addClass("disabled"),t(".todo-status").text("进行中")):t(".todo-status").text("未开始")},initToDoOprate:function(){var e=this;this.dom.on("click",".btn-detail",function(o){if(o.preventDefault(),!t(this).hasClass("disabled")){var a=t(this).data("id"),n=t(this).data("status");return-2===parseInt(n)?void(window.location.href="/edit/"+a):void t.ajax({url:"/edit-todo",type:"post",data:{id:a,update:{status:n}},success:function(t){console.log(t),1===t.code&&(todoStatus=n,alert(t.msg),e.initPage())},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})}})}},l={dom:t(".main"),init:function(){this.initStatis(),this.initPage()},initPage:function(){var e=0,o=t(".container-wrap");this.dom.on("click",".static-item",function(a){a.preventDefault();var n=t(this).index();n!==e&&(t(".static-item").eq(e).removeClass("static-item-on"),t(this).addClass("static-item-on"),e=n,o.animate({marginLeft:"-"+100*n+"%"},800))})},initStatis:function(){var e=this;t.ajax({url:"/doStatistic",type:"get",success:function(o){console.log(o),1===o.code&&(e.drawChart(t("#statis-ability"),o.result.ability),e.drawChart(t("#statis-status"),o.result.status),e.drawChart(t("#statis-course"),o.result.course))},error:function(t){console.log(t)}}).done(function(){console.log("success")}).fail(function(){console.log("error")})},drawChart:function(t,e){t.highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:e.title},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}},series:[{type:"pie",name:"所占比重",data:e.result}]})}};-1!=e.indexOf("home")&&i.init(),-1==e.indexOf("create")&&-1==e.indexOf("edit")||r.init(),-1!=e.indexOf("detail")&&c.init(),-1!=e.indexOf("statistic")&&l.init()})});